{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}

<main class="w-full px-4 py-16">
  <div class="max-w-4xl mx-auto">

    <!-- Header -->
    <section class="mb-12 text-center">
      <h2 class="text-4xl md:text-5xl font-extrabold uppercase tracking-wider text-white mb-4">
        {{ community.name }}
      </h2>
      <p class="text-lg text-gray-300 max-w-2xl mx-auto">
        {{ community.description }}
      </p>
    </section>

    <!-- Create New Discussion -->
    <section class="bg-white rounded-2xl shadow-lg border border-gray-200/80 p-8 mb-16">
      <h3 class="text-2xl font-bold text-gray-900 mb-6">Start a New Discussion</h3>
      <form action="{% url 'create_post' community.id %}" method="POST" class="space-y-4">
        {% csrf_token %}
        <div class="flex flex-col gap-4">
          <input 
            type="text" 
            name="title" 
            class="w-full rounded-lg border border-gray-300 px-4 py-3 text-gray-900 placeholder-gray-500 focus:ring-[#C1D752] focus:border-[#C1D752] transition-all"
            placeholder="Enter a topic title (e.g., 'Best Tennis Gear for Beginners')" required>

          <textarea 
            name="content" 
            rows="5"
            class="w-full rounded-lg border border-gray-300 px-4 py-3 text-gray-900 placeholder-gray-500 focus:ring-[#C1D752] focus:border-[#C1D752] transition-all"
            placeholder="Write your thoughts or questions here..." required></textarea>
        </div>

        <div class="flex justify-end mt-6">
          <button type="submit" class="bg-[#C1D752] text-gray-900 font-bold py-2.5 px-8 rounded-lg shadow-md hover:brightness-90 hover:-translate-y-0.5 transition-all duration-300">
            Post Discussion
          </button>
        </div>
      </form>
    </section>

    <!-- Divider -->
    <div class="border-b border-gray-700 mb-12"></div>

    <!-- Community Posts -->
    <section>
      <h3 class="text-3xl font-bold text-white mb-8 text-center md:text-left">Community Discussions</h3>

      <div class="space-y-10">
        {% for post in posts %}
        <article class="bg-white rounded-xl shadow-md border border-gray-200/70 overflow-hidden">
          <!-- Post header -->
          <div class="p-6">
            <div class="flex justify-between items-start gap-3">
              <div class="flex-1">
                <div class="flex justify-between items-center mb-2">
                  <h4 class="text-2xl font-bold text-gray-900">{{ post.title }}</h4>
                  <small class="text-sm text-gray-500">{{ post.created_at|timesince }} ago</small>
                </div>
                <div class="flex items-center mb-3">
                  <span class="text-sm font-semibold text-blue-700">@{{ post.author.username }}</span>
                </div>
              </div>

              {% if request.user.is_staff or request.user.is_superuser %}
              <form action="{% url 'delete_post' post.id %}" method="POST" class="shrink-0">
                {% csrf_token %}
                <button type="submit"
                        class="px-3 py-1.5 rounded-md bg-red-500 text-white text-xs font-semibold hover:bg-red-600 transition-all js-confirm-delete"
                        data-confirm="Delete this post? This action cannot be undone.">
                  Delete Post
                </button>
              </form>
              {% endif %}
            </div>

            <p class="text-gray-800 text-base md:text-lg leading-relaxed">{{ post.content }}</p>
          </div>

          <!-- Replies -->
          <div class="bg-gray-50 px-6 py-5 space-y-5 border-t border-gray-200">
            {% for reply in post.replies.all %}
            <div class="bg-white rounded-lg border border-gray-200 px-5 py-3 shadow-sm">
              <div class="flex justify-between items-start gap-3">
                <div class="flex-1">
                  <div class="flex justify-between items-baseline">
                    <span class="font-semibold text-gray-800 text-sm">@{{ reply.author.username }}</span>
                    <small class="text-xs text-gray-500">{{ reply.created_at|timesince }} ago</small>
                  </div>
                  <p class="text-gray-700 text-sm mt-2 leading-snug">{{ reply.content }}</p>
                </div>

                {% if request.user.is_staff or request.user.is_superuser %}
                <form action="{% url 'delete_reply' reply.id %}" method="POST" class="shrink-0">
                  {% csrf_token %}
                  <button type="submit"
                          class="px-2.5 py-1 rounded-md bg-red-500 text-white text-xs font-semibold hover:bg-red-600 transition-all js-confirm-delete"
                          data-confirm="Delete this reply? This action cannot be undone.">
                    Delete
                  </button>
                </form>
                {% endif %}
              </div>
            </div>
            {% empty %}
            <p class="text-gray-400 text-sm italic">No replies yet — be the first to respond!</p>
            {% endfor %}
          </div>

          <!-- Reply Form -->
          <div class="bg-gray-100 px-6 py-4 border-t border-gray-300">
            <form action="{% url 'create_reply' post.id %}" method="POST" class="flex gap-3 items-center">
              {% csrf_token %}
              <input 
                type="text" 
                name="content" 
                class="w-full rounded-full border border-gray-300 px-4 py-2 text-sm text-gray-900 placeholder-gray-500 focus:ring-blue-500 focus:border-blue-500 transition-all"
                placeholder="Write a reply..." required>
              <button type="submit" class="bg-blue-600 text-white rounded-full px-5 py-2 text-sm font-semibold hover:bg-blue-700 transition-all">
                Reply
              </button>
            </form>
          </div>
        </article>
        {% empty %}
        <div class="bg-white rounded-2xl shadow-xl max-w-lg mx-auto p-10 md:p-12 text-center text-gray-900 border border-gray-200/70">
          <h3 class="text-2xl font-bold mb-3">Be the first to start a discussion!</h3>
          <p class="text-gray-600">No posts yet — share your thoughts using the form above.</p>
        </div>
        {% endfor %}
      </div>
    </section>

  </div>
</main>

<script>
  // confirm sebelum delete (post & reply)
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.js-confirm-delete');
    if (!btn) return;
    const msg = btn.getAttribute('data-confirm') || 'Are you sure?';
    if (!confirm(msg)) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, { capture: true });
</script>

{% endblock %}
