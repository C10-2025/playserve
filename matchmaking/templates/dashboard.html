{% extends "base.html" %}
{% load static %}

{% block meta %}
    <title>Matchmaking</title>
{% endblock meta %}

{% block content %}

    {% include 'navbar.html' %} 

    <div class="matchmaking-bg-wrapper relative w-full min-h-screen pt-10 pb-12 bg-blue-800 bg-cover bg-center">
        
        <div class="container mx-auto px-4">

            {% if view_type == 'ACTIVE_MATCH' %}
                {% include 'active_match_mode.html' %} 
                
            {% elif view_type == 'NO_PROFILE' %}
                {% elif view_type == 'IDLE_FRAME' %}
                {% include 'idle_match_mode.html' %} 
            {% endif %}
            
            <div id="message-container" class="mt-3"></div>
        </div>
    </div>
{% endblock content %}


{% block extra_js %}
    {% if view_type == 'IDLE_FRAME' or view_type == 'ACTIVE_MATCH' %}
        <script>
            const STATIC_ROOT_URL = "{% static '' %}";
            const BACKGROUND_URL = "{% static 'image/background_matchmaking.svg' %}";
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.startsWith(name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');


            function showMessage(message, type = 'success') {
                const sanitizedMessage = DOMPurify.sanitize(`<div class="alert alert-${type}">${message}</div>`);
                const container = $('#message-container');
                container.html(sanitizedMessage);
                setTimeout(() => container.empty(), 5000);
            }

            function setMatchMode(activeButtonId) {
                $('#btn-available-users').removeClass('btn-primary').addClass('btn-secondary');
                $('#btn-incoming-requests').removeClass('btn-primary').addClass('btn-secondary');
                
                $(activeButtonId).removeClass('btn-secondary').addClass('btn-primary');
            }

            function renderAvailableUsers(users) {
                let html = '';
                
                
                if (users.length === 0) {
                    html += '<div class="w-full text-center p-4 rounded-lg" style="color: white; background-color: var(--dark-text); border: 2px solid var(--dark-text);">No players available to request right now.</div>';
                } else {
                    users.forEach(user => {
                        const avatarUrl = STATIC_ROOT_URL + user.avatar; 
                        
                        const instagramHtml = (user.instagram && user.instagram !== 'N/A') ? 
                            `
                            <a href="https://instagram.com/${user.instagram}" target="_blank" 
                            class="hover:underline transition duration-150">
                                @${user.instagram}
                            </a>
                            ` 
                            : 'N/A';
                        
                        let rankBadgeHtml = '';
                        if (user.rank) {
                            const rankFileName = user.rank.toLowerCase();
                            const rankBadgeUrl = STATIC_ROOT_URL + 'image/' + rankFileName + '.svg';
                            
                            rankBadgeHtml = `
                                <img src="${rankBadgeUrl}" alt="${user.rank} Rank" 
                                    class="rank-badge absolute w-12 h-12 bottom-0 right-0" 
                                    style="bottom: -8px; right: -8px;">
                            `;
                        }

                        html += `
                            <div class="w-full md:w-1/2 lg:w-1/3 px-3 mb-6"> 
                                <div class="match-card bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                                    
                                    <div class="grid grid-cols-2 grid-rows-3 gap-2 items-center">
                                        
                                        <div class="row-span-2 flex justify-center items-center p-2">
                                            <div class="relative"> 
                                                <img src="${avatarUrl}" alt="Avatar" class="match-avatar w-24 h-24 rounded-full object-cover border-4" style="border-color: var(--lime-green);">
                                                ${rankBadgeHtml} </div>
                                        </div>
                                        
                                        <div class="p-1">
                                            <h4 class="text-2xl font-extrabold mb-0 text-left" style="color: var(--dark-text);">${user.username}</h4>
                                        </div>
                                        
                                        <div class="p-1">
                                            <p class="text-xl text-gray-500 mb-0 text-left">${instagramHtml}</p> 
                                        </div>
                                        
                                        <div class="col-span-2 pt-2">
                                            <button class="btn-send-request w-full font-bold py-2 px-4 rounded-lg transition duration-150 hover:scale-[1.02] hover:brightness-110" 
                                                    style="background-color: var(--lime-green); color: var(--dark-text); border: 2px solid var(--lime-green);"
                                                    data-user-id="${user.user_id}">
                                                REQUEST MATCH
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                $('#match-content').html(html);
            }
                        
            function renderIncomingRequests(requests) {
                let html = '';
                
                if (requests.length === 0) {
                    html += '<div class="w-full text-center p-4 rounded-lg" style="color: white; background-color: var(--dark-text); border: 2px solid var(--dark-text);">There is no request...</div>';
                } else {
                    requests.forEach(req => {
                        const senderAvatarUrl = STATIC_ROOT_URL + req.sender_avatar; 
                        
                        const senderInstagramHtml = Boolean(req.sender_instagram) ? 
                            `
                            <a href="https://instagram.com/${req.sender_instagram}" target="_blank" 
                            class="hover:underline transition duration-150">
                                @${req.sender_instagram}
                            </a>
                            ` 
                            : 'N/A';
                        
                        let rankBadgeHtml = '';
                        if (req.sender_rank) {
                            const rankFileName = req.sender_rank.toLowerCase();
                            const rankBadgeUrl = STATIC_ROOT_URL + 'image/' + rankFileName + '.svg';
                            
                            rankBadgeHtml = `
                                <img src="${rankBadgeUrl}" alt="${req.sender_rank} Rank" 
                                    class="rank-badge absolute w-12 h-12 bottom-0 right-0" 
                                    style="bottom: -8px; right: -8px;"> 
                            `;
                        }
                        
                        html += `
                            <div class="w-full md:w-1/2 lg:w-1/3 px-3 mb-6">
                                <div class="match-card incoming-card bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                                    
                                    <div class="grid grid-cols-2 grid-rows-3 gap-2 items-center">

                                        <div class="row-span-2 flex justify-center items-center p-2">
                                            <div class="relative"> 
                                                <img src="${senderAvatarUrl}" alt="Avatar" class="match-avatar w-24 h-24 rounded-full object-cover border-4" style="border-color: var(--lime-green);">
                                                ${rankBadgeHtml} </div>
                                        </div>
                                        
                                        <div class="p-1">
                                            <h4 class="text-2xl font-extrabold mb-0 text-left" style="color: var(--dark-text);">${req.sender_username}</h4>
                                        </div>
                                        
                                        <div class="p-1">
                                            <p class="text-xl text-gray-500 mb-0 text-left">${senderInstagramHtml}</p>
                                        </div>
                                        
                                        <div class="col-span-2 pt-2 flex w-full space-x-2">
                                            
                                            <button class="btn-handle-request flex-1 font-bold py-2 px-4 rounded-lg transition duration-150 hover:scale-[1.02] hover:brightness-110" 
                                                    style="background-color: var(--lime-green); color: var(--dark-text); border: 2px solid var(--lime-green);"
                                                    data-request-id="${req.request_id}" 
                                                    data-action="ACCEPT">
                                                ACCEPT
                                            </button>
                                            
                                            <button class="btn-handle-request flex-1 font-bold py-2 px-4 rounded-lg transition duration-150 hover:scale-[1.02] hover:brightness-90" 
                                                    style="background-color: var(--dark-text); color: white; border: 2px solid var(--dark-text);"
                                                    data-request-id="${req.request_id}" 
                                                    data-action="REJECT">
                                                REJECT
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                $('#match-content').html(html);
            }


            $(document).ready(function() {
                
                const bgWrapper = document.querySelector('.matchmaking-bg-wrapper');
                if (bgWrapper) {
                    bgWrapper.style.backgroundImage = `url('${BACKGROUND_URL}')`;
                }

                $('#btn-available-users').on('click', function() {
                    setMatchMode('#btn-available-users');
                    $('#match-content').html('<div class="text-center">Load users...</div>');
                    $.ajax({
                        url: '{% url "matchmaking:api_available_users" %}',
                        type: 'GET',
                        success: function(response) {
                            renderAvailableUsers(response.users);
                        },
                        error: function() {
                            showMessage('Error', 'danger');
                        }
                    });
                });

                $('#btn-incoming-requests').on('click', function() {
                    setMatchMode('#btn-incoming-requests'); 
                    $('#match-content').html('<div class="text-center">Load request...</div>');
                    $.ajax({
                        url: '{% url "matchmaking:api_incoming_requests" %}',
                        type: 'GET',
                        success: function(response) {
                            renderIncomingRequests(response.requests);
                        },
                        error: function() {
                            showMessage('Error', 'danger');
                        }
                    });
                });


                if ('{{ view_type }}' === 'IDLE_FRAME') { 
                    $('#btn-available-users').click(); 
                }
                
                $(document).on('click', '.btn-send-request', function() {
                    const userId = $(this).data('user-id');
                    const button = $(this);
                    button.prop('disabled', true).text('Sending...');

                    $.ajax({
                        url: '{% url "matchmaking:action_create_request" %}',
                        type: 'POST',
                        contentType: 'application/json',
                        headers: {'X-CSRFToken': csrftoken},
                        data: JSON.stringify({ 'receiver_id': userId }),
                        success: function(response) {
                            showMessage(response.message, 'success');
                            $('#btn-available-users').click();
                        },
                        error: function(xhr) {
                            const error = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred while sending the request.';
                            showMessage(error, 'danger');
                            button.prop('disabled', false).text('REQUEST MATCH');
                        }
                    });
                });

                $(document).on('click', '.btn-handle-request', function() {
                    const requestId = $(this).data('request-id');
                    const action = $(this).data('action');
                    
                    $.ajax({
                        url: '{% url "matchmaking:action_handle_request" %}',
                        type: 'POST',
                        contentType: 'application/json',
                        headers: {'X-CSRFToken': csrftoken},
                        data: JSON.stringify({ 'request_id': requestId, 'action': action }),
                        success: function(response) {
                            showMessage(response.message, 'success');
                            if (response.redirect) {
                                window.location.href = response.redirect; 
                            } else {
                                $('#btn-incoming-requests').click();
                            }
                        },
                        error: function(xhr) {
                            const error = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred while sending the request.';
                            showMessage(error, 'danger');
                        }
                    });
                });
                
                if ($('.active-match-container').length) { 
                    $('.btn-session-action').on('click', function() {
                        const sessionId = $(this).data('session-id');
                        const action = $(this).data('action'); 
                        
                        if (action === 'CANCEL' && !confirm('Are you sure you want to cancel this match?')) {
                            return;
                        }
                        
                        $('.btn-session-action').prop('disabled', true).text('Processing...');

                        $.ajax({
                            url: '{% url "matchmaking:action_finish_session" %}',
                            type: 'POST',
                            contentType: 'application/json',
                            headers: {'X-CSRFToken': csrftoken},
                            data: JSON.stringify({ 'session_id': sessionId, 'action': action }),
                            success: function(response) {
                                showMessage(response.message, 'success');
                                if (response.redirect) {
                                    window.location.href = response.redirect; 
                                }
                            },
                            error: function(xhr) {
                                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to complete the session.';
                                showMessage(error, 'danger');
                                $('.btn-session-action').prop('disabled', false).text('Try again.');
                            }
                        });
                    });
                }

            });
        </script>
    {% endif %}
{% endblock extra_js %}