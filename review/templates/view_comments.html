{% load static %}

<div id="view-comments-container">

<style>
.comment-modal-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.comment-modal {
  background: #ffffff; /* white background */
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  width: 90%;
  max-width: 520px;
  padding: 24px;
  position: relative;
  border: 2px solid #d6e8c5;
  font-family: "Poppins", sans-serif;
  color: #1a2b4c; /* dark text for readability */
  max-height: 80vh;
  overflow-y: auto;
}

.close-btn { 
  position: absolute; 
  top: 12px; 
  right: 16px; 
  background:none; 
  border:none; 
  font-size:26px; 
  cursor:pointer; 
  color:#1a2b4c; 
}

.comment-item { 
  background:#f7f7f7; 
  border-radius:10px; 
  padding:12px 14px; 
  margin-bottom:10px;
  position: relative;
  color:#1a2b4c; 
}

.comment-stars { 
  color:#FFD700; 
  font-size:1.1rem; 
  margin-bottom:6px;
}

.comment-text { 
  margin-bottom: 8px;
  color:#1a2b4c; 
}

.delete-comment-btn {
  background: #ff4444;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
  margin-top: 8px;
}

.delete-comment-btn:hover {
  background: #cc0000;
}

.empty { 
  text-align:center; 
  color:#555; /* empty state */
  font-style:italic; 
}
</style>

<div class="comment-modal-overlay">
  <div class="comment-modal">
    <button class="close-btn" onclick="document.getElementById('view-comments-container').remove()">×</button>
    <h3 style="margin-top:6px;">Comments for {{ field.name }}</h3>
    <p style="color:#445; margin-bottom:12px">
      Address: {{ field.address }} • Price: Rp {{ field.price_per_hour }}
    </p>

    <div id="comments-list">
      {% if comments %}
        {% for c in comments %}
          <div class="comment-item" id="comment-{{ c.id }}">
            <div class="comment-stars">
              {% for i in "12345" %}
                {% if forloop.counter <= c.rating %}★{% else %}☆{% endif %}
              {% endfor %}
            </div>
            <div class="comment-text">{{ c.komentar }}</div>
            {% if is_admin %}
              <button class="delete-comment-btn" data-review-id="{{ c.id }}" data-field-id="{{ field.id }}" onclick="deleteComment('{{ c.id }}')">Delete Comment</button>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p class="empty">No comments yet for this field.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function deleteComment(reviewId) {
  if (!confirm("Are you sure you want to delete this comment?")) return;

  const url = `{% url 'review:delete-review' 0 %}`.replace('/0/', `/${reviewId}/`);

  fetch(url, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(resp => {
    const contentType = resp.headers.get("content-type") || "";
    if (contentType.includes("application/json")) {
      return resp.json();
    } else {
      return resp.text().then(text => {
        throw new Error(`Non-JSON response: ${text.substring(0, 200)}`);
      });
    }
  })
  .then(data => {
    if (data.status === 'success') {
      const element = document.getElementById(`comment-${reviewId}`);
      if (element) element.remove();

      const commentsList = document.getElementById('comments-list');
      if (commentsList && commentsList.children.length === 0) {
        commentsList.innerHTML = '<p class="empty">No comments yet for this field.</p>';
      }

      // Reload to update review preview
      setTimeout(() => {
        window.location.reload();
      }, 500);
    } else {
      alert(data.message || 'Failed to delete comment.');
    }
  })
  .catch(err => {
    console.error('Delete error:', err);
    alert('An error occurred: ' + err.message);
  });
}
</script>

</div>
